
<!DOCTYPE html>
<html>
{% load staticfiles %}
<head lang="en">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>支付页面</title>
<link rel="stylesheet" type="text/css" href="{% static 'DiningServer/css/swiper.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'DiningServer/css/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'DiningServer/css/orderPay.css' %}">
</head>

<body>

<div class="box-timer">

    <!--剩余时间-->
    <div class="timer-surplus">
        <a href="javascript:;"></a>
        <a href="javascript:;">支付剩余时间</a>
        <p class="timer-tm" id="timer">
            15:00
        </p>
    </div>
    
    <!--结算信息-->
    <div class="setent">结算信息</div>
    <div class="set-box">
        <p>订单号: {{ bill.id }}</p>
        <p>订单总价: {{ sum }}</p>
    </div>

    <!--支付方式-->
    <div class="setent">选择支付方式</div>
    <div class="payment-box">
        <div></div>
        <div>
            <p>微信支付</p>
            <p>推荐安装微信5.0及以上版本的使用</p>
        </div>
        <div></div>
    </div>
    <div class="compayment" id="compayment">确认支付</div>
</div>



<script type="text/javascript" src="{% static 'DiningServer/js/Adaptive.js' %}"></script>
<script type="text/javascript" src="{% static 'DiningServer/js/jquery-1.7.1.min.js' %}"></script>
<script type="text/javascript" src="{% static 'DiningServer/js/jweixin-1.0.0.js' %}"></script>
<script type="text/javascript">
    function to(num){
        return num<10?'0'+num:''+num;
    }
    var Timer=document.getElementById('timer');
    var t=15*60;
    setInterval(function(){
        t--;
        var m=Math.floor(t/60);
        var s=t%60;
        Timer.innerHTML=m+':'+to(s);
        
        if(t==1){
            alert('您已超过支付时间，请您重新提交订单及时支付');
            window.location.href ='/DiningServer/index/';
        }
    },1000);


    var json = {};
    var $compayment = $("#compayment")
            , url = '/DiningServer/payOrderTest/{{bill.id}}/';

//选好了提交
    $compayment.on ("click", function () {
        //StandardPost('/DiningServer/payOrderTest/{{bill.id}}/',json);
        onBridgeReady();
    });


     function StandardPost(url,args) {
        var body = $(document.body),
            form = $("<form method='post'></form>"),
             input;
        form.attr({"action":url});
        $.each(args,function(key,value){
            input = $("<input  type='hidden'>");
            input.attr({"name":key});
            input.val(value);
            form.append(input);
         });

        form.appendTo(document.body);
        form.submit();
        document.body.removeChild(form[0]);
    }

    function onBridgeReady(){
       WeixinJSBridge.invoke(
           'getBrandWCPayRequest', {
               "appId" :   "{{appId}}", 
               "timeStamp":"{{timeStamp}}",    
               "nonceStr" :"{{nonceStr}}",    
               "package" : "{{package}}",     
               "signType" :"{{signType}}",  
               "paySign" : "{{paySign}}" 
           },
           function(res){     
               if(res.err_msg == "get_brand_wcpay_request：ok" ) {}     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
           }
       ); 
    }
    if (typeof WeixinJSBridge == "undefined"){
       if( document.addEventListener ){
           document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
       }else if (document.attachEvent){
           document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
           document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
       }
    }else{
       onBridgeReady();
    } 
</script>
</body>
</html>